<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>这里是云风青的blog</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
    <!-- 配置信息（供JS读取） -->
    <script id="blog-settings" type="application/json">
        {"title":"云风青的技术博客","introduction":"欢迎来到云风青的blog！这里分享技术心得和学习笔记"}
    </script>

    <header>
        <h1 id="blog-title">技术博客</h1>
        <p class="header-desc" id="blog-intro">显示别名和修改时间的博客示例</p>
        
        <!-- 登录相关元素 -->
        <div class="login-container">
            <span class="username-display" id="username-display"></span> <!-- 用户名显示 -->
            <div class="avatar-btn" id="avatar-btn">
                <img src="" alt="用户头像" class="avatar-img" id="avatar-img" style="display: none;">
                <i class="fa fa-user" id="default-avatar" style="color: #6b7280;"></i>
            </div>
            
            <div class="login-menu" id="login-menu">
                <div class="menu-item" id="login-item">
                    <i class="fa fa-sign-in"></i> 登录
                </div>
                <div class="menu-divider"></div>
                <div class="menu-item disabled" id="logout-item">
                    <i class="fa fa-sign-out"></i> 登出
                </div>
                <div class="menu-item disabled" id="refresh-item">
                    <i class="fa fa-refresh"></i> 刷新
                </div>
                <div class="menu-item disabled" id="api-status-item">
                    <i class="fa fa-bar-chart"></i> 查询API状态
                </div>
                
                <!-- 登录表单 -->
                <div id="login-form" style="display: none; padding: 0 1rem 1rem;">
                    <input type="password" class="token-input" id="github-token" placeholder="输入GitHub Token (ghp_xxx...)">
                    <button class="login-btn" id="submit-login">确认登录</button>
                </div>
            </div>
        </div>
    </header>

    <!-- API状态弹窗 -->
    <div class="api-status-modal" id="api-status-modal">
        <div class="modal-content">
            <h3 class="modal-title">API 限流状态</h3>
            <div class="info-item">
                <strong>用户名：</strong>
                <span id="modal-user-login">-</span>
            </div>
            <div class="info-item">
                <strong>Core API 剩余次数：</strong>
                <span id="modal-core-remaining">-</span> / <span id="modal-core-limit">-</span>
            </div>
            <div class="info-item">
                <strong>Core API 重置时间：</strong>
                <span id="modal-core-reset">-</span>
            </div>
            <div class="info-item">
                <strong>Search API 剩余次数：</strong>
                <span id="modal-search-remaining">-</span> / <span id="modal-search-limit">-</span>
            </div>
            <div class="info-item">
                <strong>Search API 重置时间：</strong>
                <span id="modal-search-reset">-</span>
            </div>
            <div class="info-item">
                <strong>GraphQL API 剩余次数：</strong>
                <span id="modal-graphql-remaining">-</span> / <span id="modal-graphql-limit">-</span>
            </div>
            <button class="close-modal" id="close-modal">关闭</button>
        </div>
    </div>

    <div class="tag-cloud">
        <h2>标签云</h2>
        <div class="tags-container" id="tags-container"></div>
    </div>

    <div class="loading" id="loading">正在加载博客内容...</div>
    <div id="blog-container" style="display: none;"></div>
    <div class="no-results" id="no-results" style="display: none;">没有找到匹配标签的文章</div>

    <!-- 引入GitHub API封装和主逻辑 -->
    <script type="module" src="./js/github-api.js"></script>
    <script type="module">
        import { 
            Octokit, 
            getFileCommits, 
            getUserInfo, 
            getRateLimit 
        } from './js/github-api.js';

        // 从当前URL解析GitHub用户名和仓库名
        const hostname = window.location.hostname;
        const owner = hostname.split('.github.io')[0]; // 提取用户名（如hugill-8121）
        const repo = hostname; // 仓库名即域名（如hugill-8121.github.io）
        const config = {
            owner: owner,
            repo: repo,
            branch: 'main'
        };

        // 存储博客数据
        let allBlogs = [];
        let allTags = new Set();

        // DOM元素
        const blogContainer = document.getElementById('blog-container');
        const tagsContainer = document.getElementById('tags-container');
        const noResultsEl = document.getElementById('no-results');
        const loadingEl = document.getElementById('loading');
        const blogTitle = document.getElementById('blog-title');
        const blogIntro = document.getElementById('blog-intro');

        // 登录相关DOM
        const avatarBtn = document.getElementById('avatar-btn');
        const loginMenu = document.getElementById('login-menu');
        const loginItem = document.getElementById('login-item');
        const logoutItem = document.getElementById('logout-item');
        const refreshItem = document.getElementById('refresh-item');
        const apiStatusItem = document.getElementById('api-status-item');
        const loginForm = document.getElementById('login-form');
        const githubTokenInput = document.getElementById('github-token');
        const submitLoginBtn = document.getElementById('submit-login');
        const avatarImg = document.getElementById('avatar-img');
        const defaultAvatar = document.getElementById('default-avatar');
        const usernameDisplay = document.getElementById('username-display');

        // API状态弹窗DOM
        const apiStatusModal = document.getElementById('api-status-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalUserLogin = document.getElementById('modal-user-login');
        const modalCoreRemaining = document.getElementById('modal-core-remaining');
        const modalCoreLimit = document.getElementById('modal-core-limit');
        const modalCoreReset = document.getElementById('modal-core-reset');
        const modalSearchRemaining = document.getElementById('modal-search-remaining');
        const modalSearchLimit = document.getElementById('modal-search-limit');
        const modalSearchReset = document.getElementById('modal-search-reset');
        const modalGraphqlRemaining = document.getElementById('modal-graphql-remaining');
        const modalGraphqlLimit = document.getElementById('modal-graphql-limit');

        // 初始化
        async function init() {
            loadBlogSettings(); // 加载博客配置
            checkLoginStatus(); // 检查登录状态
            await initBlog();   // 初始化博客内容
            bindEvents();       // 绑定事件
        }

        // 加载博客标题和介绍（从配置中读取）
        function loadBlogSettings() {
            try {
                const settingsEl = document.getElementById('blog-settings');
                const settings = JSON.parse(settingsEl.textContent);
                if (settings.title) blogTitle.textContent = settings.title;
                if (settings.introduction) blogIntro.textContent = settings.introduction;
            } catch (err) {
                console.warn('加载博客配置失败，使用默认值:', err);
            }
        }

        // 初始化博客内容
        async function initBlog() {
            try {
                const response = await fetch('blog-config.json');
                if (!response.ok) throw new Error('配置文件加载失败');
                
                const blogConfig = await response.json();
                await processBlogData(blogConfig);
                renderTags();
                renderBlogs();

                loadingEl.style.display = 'none';
                blogContainer.style.display = 'block';

            } catch (error) {
                console.error('初始化失败:', error);
                loadingEl.innerHTML = `<p style="color: red;">加载失败: ${error.message}</p>`;
            }
        }

        // 处理博客数据（添加提交信息等元数据）
        async function processBlogData(blogs) {
            // 使用正确的容器ID（原错误点：使用了不存在的blog-cards）
            const blogCardsContainer = document.getElementById('blog-container');
            
            // 1. 显示加载状态
            blogCardsContainer.innerHTML = '<div class="loading">正在加载博客列表...</div>';

            try {
                // 2. 提取所有文件路径并存储完整博客数据
                allBlogs = []; // 清空现有博客数据
                allTags.clear(); // 清空现有标签
                
                // 处理分组数据，提取所有博客和标签
                Object.keys(blogs).forEach(group => {
                    blogs[group].forEach(blog => {
                        // 为每个博客添加分组信息
                        blog.group = group;
                        allBlogs.push(blog);
                        
                        // 收集所有标签
                        blog.tags.forEach(tag => allTags.add(tag));
                    });
                });
                
                // 提取文件路径数组
                const filePaths = allBlogs.map(blog => blog.filePath);
                
                // 3. 调用批量接口一次性获取所有文件的提交信息
                const batchResults = await batchGetFileCommits(
                    config.owner,         // 使用配置的仓库所有者
                    config.repo,          // 使用配置的仓库名称
                    filePaths,           
                    config.branch,        // 使用配置的分支
                    document.getElementById('github-token')?.value.trim() || null,
                    100                   
                );

                // 4. 将批量结果转换为 Map（路径 -> 最新提交）
                const commitMap = new Map();
                batchResults.forEach(item => {
                    if (!item.error && item.commits.length > 0) {
                        commitMap.set(item.path, item.commits[0]);
                        // 为博客添加最后修改时间
                        const blog = allBlogs.find(b => b.filePath === item.path);
                        if (blog) {
                            blog.lastModified = new Date(item.commits[0].commit.committer.date);
                        }
                    }
                });

                // 5. 清空容器，准备渲染
                blogCardsContainer.innerHTML = '';
                
                // 6. 按分类渲染博客卡片
                renderBlogs();

            } catch (error) {
                // 7. 错误处理
                blogCardsContainer.innerHTML = `
                <div class="error">
                    加载博客失败: ${error.message}
                    <button onclick="refreshBlogData()">重试</button>
                </div>
                `;
            }
        }

        // 渲染标签云
        function renderTags() {
            tagsContainer.innerHTML = '';
            
            const allTagEl = document.createElement('span');
            allTagEl.className = 'tag active';
            allTagEl.textContent = '全部';
            allTagEl.addEventListener('click', () => {
                document.querySelectorAll('.tag').forEach(tag => tag.classList.remove('active'));
                allTagEl.classList.add('active');
                renderBlogs();
            });
            tagsContainer.appendChild(allTagEl);
            
            Array.from(allTags).forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.textContent = tag;
                
                tagEl.addEventListener('click', () => {
                    document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                    tagEl.classList.add('active');
                    renderBlogs(tag);
                });
                
                tagsContainer.appendChild(tagEl);
            });
        }

        // 渲染博客卡片
        function renderBlogs(filterTag = null) {
            blogContainer.innerHTML = '';
            
            const filteredBlogs = filterTag 
                ? allBlogs.filter(blog => blog.tags.includes(filterTag))
                : allBlogs;
            
            if (filteredBlogs.length === 0) {
                noResultsEl.style.display = 'block';
                return;
            } else {
                noResultsEl.style.display = 'none';
            }
            
            const blogsByCategory = {};
            filteredBlogs.forEach(blog => {
                if (!blogsByCategory[blog.category]) {
                    blogsByCategory[blog.category] = [];
                }
                blogsByCategory[blog.category].push(blog);
            });
            
            Object.keys(blogsByCategory).forEach(categoryName => {
                const categorySection = document.createElement('section');
                categorySection.className = 'category-section';
                
                const categoryHeader = document.createElement('h2');
                categoryHeader.className = 'category-title';
                categoryHeader.textContent = categoryName;
                categorySection.appendChild(categoryHeader);
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'cards-container';
                
                blogsByCategory[categoryName].forEach(article => {
                    cardsContainer.appendChild(createBlogCard(article));
                });
                
                categorySection.appendChild(cardsContainer);
                blogContainer.appendChild(categorySection);
            });
        }

        // 创建博客卡片
        function createBlogCard(article) {
            const card = document.createElement('div');
            card.className = 'blog-card';
            
            const cardTitle = document.createElement('h3');
            cardTitle.className = 'card-title';
            cardTitle.textContent = article.alias;
            card.appendChild(cardTitle);
            
            const cardDesc = document.createElement('p');
            cardDesc.className = 'card-desc';
            cardDesc.textContent = article.description || '暂无描述';
            card.appendChild(cardDesc);
            
            const cardTags = document.createElement('div');
            cardTags.className = 'card-tags';
            article.tags.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'card-tag';
                tagSpan.textContent = tag;
                cardTags.appendChild(tagSpan);
            });
            card.appendChild(cardTags);
            
            const cardMeta = document.createElement('div');
            cardMeta.className = 'card-meta';
            if (article.lastModified) {
                cardMeta.innerHTML = `<i class="fa fa-clock-o"></i> 最后更新: ${article.lastModified.toLocaleString()}`;
            } else {
                cardMeta.innerHTML = `<i class="fa fa-clock-o"></i> 暂无更新信息`;
            }
            card.appendChild(cardMeta);

            // 点击卡片跳转到对应文章
            card.addEventListener('click', () => {
                // 构建带参数的目标路径
                const targetPath = `blog-show.html?group=${encodeURIComponent(article.group)}&blog=${encodeURIComponent(article.alias)}`;
                
                // 跳转方式适配
                window.location.href = targetPath;
            });

            return card;
        }

        // 刷新博客数据
        async function refreshBlogData() {
            try {
                const response = await fetch('blog-config.json');
                if (!response.ok) throw new Error('配置文件加载失败');
                
                const blogConfig = await response.json();
                await processBlogData(blogConfig);
                renderTags();
                renderBlogs();
                return true;
            } catch (error) {
                console.error('刷新博客数据失败:', error);
                throw error;
            }
        }

        // 批量获取文件提交信息（从test.html中移植的核心逻辑）
        async function batchGetFileCommits(owner, repo, filePaths, branch = 'main', token = null, perPage = 100) {
            const results = [];
            
            // 为每个文件创建获取提交的任务
            const tasks = filePaths.map(async (path) => {
                try {
                    const headers = {
                        'Accept': 'application/vnd.github.v3+json'
                    };
                    if (token) {
                        headers['Authorization'] = `token ${token}`;
                    }
                    
                    let allCommits = [];
                    let page = 1;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const url = new URL(`https://api.github.com/repos/${owner}/${repo}/commits`);
                        url.searchParams.append('path', path);
                        url.searchParams.append('sha', branch);
                        url.searchParams.append('per_page', perPage);
                        url.searchParams.append('page', page);
                        
                        const response = await fetch(url.toString(), { headers });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP错误: ${response.status}`);
                        }
                        
                        const commits = await response.json();
                        if (commits.length === 0) {
                            hasMore = false;
                        } else {
                            allCommits = allCommits.concat(commits);
                            page++;
                        }
                    }
                    
                    return {
                        path,
                        commits: allCommits,
                        total: allCommits.length,
                        error: null
                    };
                    
                } catch (error) {
                    return {
                        path,
                        commits: [],
                        total: 0,
                        error: error.message
                    };
                }
            });
            
            const taskResults = await Promise.all(tasks);
            
            // 按原始文件路径顺序排列结果
            filePaths.forEach(path => {
                const result = taskResults.find(item => item.path === path);
                if (result) results.push(result);
            });
            
            return results;
        }

        // 绑定事件
        function bindEvents() {
            // 登录相关事件绑定（省略具体实现，保持原有逻辑）
            avatarBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                loginMenu.style.display = loginMenu.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', () => {
                loginMenu.style.display = 'none';
            });

            loginItem.addEventListener('click', () => {
                loginForm.style.display = loginForm.style.display === 'block' ? 'none' : 'block';
            });

            submitLoginBtn.addEventListener('click', async () => {
                const token = githubTokenInput.value.trim();
                if (token) {
                    localStorage.setItem('github-token', token);
                    checkLoginStatus();
                    loginForm.style.display = 'none';
                }
            });

            logoutItem.addEventListener('click', () => {
                localStorage.removeItem('github-token');
                checkLoginStatus();
            });

            refreshItem.addEventListener('click', async () => {
                try {
                    await refreshBlogData();
                } catch (error) {
                    alert(`刷新失败: ${error.message}`);
                }
            });

            // API状态查询
            apiStatusItem.addEventListener('click', async () => {
                const token = localStorage.getItem('github-token');
                if (!token) {
                    alert('请先登录');
                    return;
                }

                try {
                    const octokit = new Octokit({ auth: token });
                    const rateLimit = await getRateLimit(octokit);
                    const userInfo = await getUserInfo(octokit);

                    // 更新弹窗信息
                    modalUserLogin.textContent = userInfo.login;
                    modalCoreRemaining.textContent = rateLimit.core.remaining;
                    modalCoreLimit.textContent = rateLimit.core.limit;
                    modalCoreReset.textContent = new Date(rateLimit.core.reset * 1000).toLocaleString();
                    modalSearchRemaining.textContent = rateLimit.search.remaining;
                    modalSearchLimit.textContent = rateLimit.search.limit;
                    modalSearchReset.textContent = new Date(rateLimit.search.reset * 1000).toLocaleString();
                    modalGraphqlRemaining.textContent = rateLimit.graphql.remaining;
                    modalGraphqlLimit.textContent = rateLimit.graphql.limit;

                    apiStatusModal.style.display = 'block';
                } catch (error) {
                    alert(`获取API状态失败: ${error.message}`);
                }
            });

            closeModalBtn.addEventListener('click', () => {
                apiStatusModal.style.display = 'none';
            });
        }

        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('github-token');
            if (token) {
                // 已登录状态
                githubTokenInput.value = token;
                logoutItem.classList.remove('disabled');
                refreshItem.classList.remove('disabled');
                apiStatusItem.classList.remove('disabled');
                loginItem.style.display = 'none';
                
                // 获取用户信息
                const octokit = new Octokit({ auth: token });
                getUserInfo(octokit).then(user => {
                    usernameDisplay.textContent = user.login;
                    avatarImg.src = user.avatar_url;
                    avatarImg.style.display = 'block';
                    defaultAvatar.style.display = 'none';
                }).catch(() => {
                    // 令牌无效时清除
                    localStorage.removeItem('github-token');
                    checkLoginStatus();
                });
            } else {
                // 未登录状态
                usernameDisplay.textContent = '';
                avatarImg.style.display = 'none';
                defaultAvatar.style.display = 'block';
                logoutItem.classList.add('disabled');
                refreshItem.classList.add('disabled');
                apiStatusItem.classList.add('disabled');
                loginItem.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }

        // 启动
        init();
    </script>
</body>
</html>